{% load humanize static %}
{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{% static 'sowaf/images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'sowaf/styles/bootsrap.min.css' %}" />
  <title>Profit & Loss</title>
  <style>
    :root{
      --brand:#39B54B; --ink:#0f5132;
      --line:#e7e7e7; --muted:#6b7280; --bg:#f4f6f8;
      --head:#f7fff8; --card:#ffffff; --warn:#fff7e6;
    }
    body{background:var(--bg);font-family:Poppins,system-ui,Segoe UI,Arial;margin:24px}
    .wrap{max-width:1100px;margin:auto}
    h1{color:var(--brand);margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:14px}

    .filters{
      display:flex; gap:10px; align-items:center; margin:12px 0 18px;
      flex-wrap:wrap;
    }
    .filters input[type="date"]{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;background:#fff}
    .btn{border:0;border-radius:8px;padding:8px 12px;font-weight:800;cursor:pointer}
    .btn.run{background:var(--brand);color:#fff}
    .btn.clear{background:#eaf7ee;color:#0f5132;border:1px solid #cfe9d6}

    .grid{
      display:grid; grid-template-columns: 1fr 320px; gap:16px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }

    .section{margin-bottom:14px}
    .section h3{
      margin:0; padding:12px 14px; border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,#e6f7ea,#f5fff8); color:var(--ink);
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 12px; border-bottom:1px solid #f1f1f1}
    th{text-align:left; background:#fbfdfc; color:#14532d; font-weight:800}
    td.num{text-align:right; white-space:nowrap}
    tr:last-child td{border-bottom:0}

    .tot-row td{font-weight:800; background:#f8fff9}
    .summary{padding:14px}
    .summary .row{display:flex; justify-content:space-between; gap:10px; margin:8px 0}
    .summary .label{color:#64748b}
    .summary .big{font-size:20px; font-weight:900; color:#0f5132}
    .neg{color:#b91c1c}
  </style>
</head>
<body>
      <a href="{% url 'sowaf:reports' %}" style="color: #39B54B; font-weight: 900; text-decoration: none; margin-left: 3%;"> < Back to Reports </a>
<div class="wrap">
  <h1 class="text-center">Profit &amp; Loss</h1>

  <div class="filters d-flex">
    <span class="sub">
      Period:
      {% if dfrom %}{{ dfrom|date:"M j, Y" }}{% else %}None{% endif %}
      â€“ {% if dto %}{{ dto|date:"M j, Y" }}{% else %}None{% endif %}
    </span>
<br><br> 
    <form method="get"  style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;" class="ms-auto">
      From <input type="date" name="from" value="{{ dfrom|date:'Y-m-d' }}">
      To <input type="date" name="to" value="{{ dto|date:'Y-m-d' }}">
      <button class="btn run" type="submit">Run</button>
      <a class="btn clear" href="{% url 'accounts:report-pnl' %}">Clear</a>
    </form>
  </div>

  <div class="grid">
    <!-- Left: sections -->
    <div class="card">
      <!-- INCOME -->
      <div class="section">
        <h3>Income</h3>
        <table>
          <thead><tr><th>Account</th><th class="num">Amount</th></tr></thead>
          <tbody>
            {% for name, amt in buckets.income %}
              <tr>
                <td>{{ name }}</td>
                <td class="num">{{ amt|floatformat:2|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" style="color:#6b7280;padding:12px">No income in this period.</td></tr>
            {% endfor %}
            <tr class="tot-row">
              <td>Total Income</td>
              <td class="num">{{ totals.income|floatformat:2|intcomma }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- COGS -->
      <div class="section">
        <h3>Cost of Goods Sold</h3>
        <table>
          <thead><tr><th>Account</th><th class="num">Amount</th></tr></thead>
          <tbody>
            {% for name, amt in buckets.cogs %}
              <tr>
                <td>{{ name }}</td>
                <td class="num">{{ amt|floatformat:2|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" style="color:#6b7280;padding:12px">No COGS in this period.</td></tr>
            {% endfor %}
            <tr class="tot-row">
              <td>Total COGS</td>
              <td class="num">{{ totals.cogs|floatformat:2|intcomma }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- EXPENSES -->
      <div class="section" style="margin-bottom:0">
        <h3>Expenses</h3>
        <table>
          <thead><tr><th>Account</th><th class="num">Amount</th></tr></thead>
          <tbody>
            {% for name, amt in buckets.expense %}
              <tr>
                <td>{{ name }}</td>
                <td class="num">{{ amt|floatformat:2|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" style="color:#6b7280;padding:12px">No expenses in this period.</td></tr>
            {% endfor %}
            <tr class="tot-row">
              <td>Total Expenses</td>
              <td class="num">{{ totals.expense|floatformat:2|intcomma }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Right: summary -->
    <div class="card summary">
      <div class="row">
        <span class="label">Total Income</span>
        <span class="value">{{ totals.income|floatformat:2|intcomma }}</span>
      </div>
      <div class="row">
        <span class="label">Total COGS</span>
        <span class="value">{{ totals.cogs|floatformat:2|intcomma }}</span>
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:8px 0">
      <div class="row">
        <span class="label"><strong>Gross Profit</strong></span>
        <span class="value"><strong>{{ gross_profit|floatformat:2|intcomma }}</strong></span>
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:8px 0">
      <div class="row">
        <span class="label">Total Expenses</span>
        <span class="value">{{ totals.expense|floatformat:2|intcomma }}</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="label big">Net Profit</span>
        <span class="big {% if net_profit < 0 %}neg{% endif %}">
          {{ net_profit|floatformat:2|intcomma }}
        </span>
      </div>
    </div>
  </div>
</div>
</body>
</html>
